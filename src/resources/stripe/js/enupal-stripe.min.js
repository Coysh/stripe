/**
 * Stripe Payments plugin for Craft CMS 3.x
 *
 * @link      https://enupal.com/
 * @copyright Copyright (c) 2018 Enupal LLC
 */
var enupalStripe={};!function(e){"use strict";enupalStripe={paymentFormsList:{},finalData:{},zeroDecimals:{},init:function(){this.paymentFormsList=e(".enupal-stripe-form"),this.zeroDecimals=["MGA","BIF","CLP","PYG","DJF","RWF","GNF","UGX","JPY","VND","VUV","XAF","KMF","KRW","XOF","XPF"],this.paymentFormsList.each(function(){var n=e(this);enupalStripe.initializeForm(n)})},initializeForm:function(n){if(void 0===e(n).find('[name="enupalStripe[stripeData]"]').val())return!1;var a=e.parseJSON(e(n).find('[name="enupalStripe[stripeData]"]').val());navigator.userAgent.indexOf("Firefox")<0&&e(n).find('[name="enupalStripe[stripeData]"]').val(""),this.finalData.finalAmount=a.stripe.amount;var t,i="stripe-payments-submit-button-"+a.paymentFormId;t=StripeCheckout.configure({key:a.pbk,token:function(e,t){n.find('[name="enupalStripe[token]"]').val(e.id),n.find('[name="enupalStripe[email]"]').val(e.email),enupalStripe.addValuesToForm(n,t,a),n.find("#"+i).prop("disabled",!0).find("span").text(a.paymentButtonProcessingText),n.unbind("submit",[n,a]),n.submit()},opened:function(){},closed:function(){}}),n.find("#"+i).on("click",function(e){var i=n[0];i.checkValidity()?(e.preventDefault(),enupalStripe.submitPayment(n,a,t)):i.reportValidity&&i.reportValidity()})},addValuesToForm:function(e,n,a){if(a.stripe.shippingAddress||a.stripe.billingAddress){var t=a.stripe.shippingAddress?"shipping":"billing";n[t+"_name"]&&e.find('[name="enupalStripe[address][name]"]').val(n[t+"_name"]),n[t+"_address_country"]&&e.find('[name="enupalStripe[address][country]"]').val(n[t+"_address_country"]),n[t+"_address_zip"]&&e.find('[name="enupalStripe[address][zip]"]').val(n[t+"_address_zip"]),n[t+"_address_state"]&&e.find('[name="enupalStripe[address][state]"]').val(n[t+"_address_state"]),n[t+"_address_line1"]&&e.find('[name="enupalStripe[address][line1]"]').val(n[t+"_address_line1"]),n[t+"_address_city"]&&e.find('[name="enupalStripe[address][city]"]').val(n[t+"_address_city"])}},submitPayment:function(n,a,t){var i=e.extend(!0,{},a),r=i.stripe;r.amount=this.convertToCents(this.getFinalAmount(n,i),r.currency),n.find('[name="enupalStripe[amount]"]').val(r.amount),n.find('[name="enupalStripe[testMode]"]').val(i.testMode),t.open(r)},getFinalAmount:function(n,a){var t=a.stripe.amount,i=0,r=!1;if(a.enableSubscriptions)if(0==a.subscriptionType){if(a.singleSetupFee>0&&(i=a.singleSetupFee),a.enableCustomPlanAmount)"undefined"!==(l=n.find('[name="enupalStripe[customPlanAmount]"]').val())&&l>0&&(t=l)}else{var s=null,l=null;if((s="radio"==a.subscriptionStyle?e('input[name="enupalStripe[enupalMultiPlan]"]:checked').val():n.find('[name="enupalStripe[enupalMultiPlan]"]').val())in a.multiplePlansAmounts&&(l=a.multiplePlansAmounts[s].amount,a.stripe.currency=a.multiplePlansAmounts[s].currency),s in a.setupFees){var p=a.setupFees[s];p>0&&(i=p)}"undefined"!==l&&l>0&&(t=l)}else if(1==a.amountType){var u=n.find('[name="enupalStripe[customAmount]"]').val();r=n.find('[name="enupalStripe[recurringToggle]"]').is(":checked"),"undefined"!==u&&u>0&&(t=u)}if((a.applyTax||r)&&a.enableTaxes){var o=parseFloat(a.tax/100*(parseFloat(t)+parseFloat(i))).toFixed(2);t=parseFloat(t)+parseFloat(o);var d=a.taxLabel+": "+a.currencySymbol+o;n.find('[name="enupalStripe[taxAmount]"]').val(o),n.find('[name="tax-amount-label"]').empty().append(d)}return parseFloat(t)+parseFloat(i)},convertToCents:function(e,n){return this.hasZeroDecimals(n)?e:(100*e).toFixed(0)},convertFromCents:function(e,n){return this.hasZeroDecimals(n)?e:e/100},hasZeroDecimals:function(e){for(var n=0;n<this.zeroDecimals.length;n++)if(this.zeroDecimals[n]===e.toUpperCase())return!0;return!1}},e(document).ready(function(e){enupalStripe.init()})}(jQuery);