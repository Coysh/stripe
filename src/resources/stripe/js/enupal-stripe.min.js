/**
 * Stripe Payments plugin for Craft CMS 3.x
 *
 * @link      https://enupal.com/
 * @copyright Copyright (c) 2018 Enupal LLC
 */
var enupalStripe={};!function(e){"use strict";enupalStripe={paymentFormsList:{},finalData:{},zeroDecimals:{},init:function(){this.paymentFormsList=e(".enupal-stripe-form"),this.zeroDecimals=["MGA","BIF","CLP","PYG","DJF","RWF","GNF","UGX","JPY","VND","VUV","XAF","KMF","KRW","XOF","XPF"],this.paymentFormsList.each(function(){var n=e(this);enupalStripe.initializeForm(n)})},initializeForm:function(n){if(void 0===e(n).find('[name="enupalStripe[stripeData]"]').val())return!1;var a=e.parseJSON(e(n).find('[name="enupalStripe[stripeData]"]').val());navigator.userAgent.indexOf("Firefox")<0&&e(n).find('[name="enupalStripe[stripeData]"]').val(""),this.finalData.finalAmount=a.stripe.amount;var t,i=this,o="stripe-payments-submit-button-"+a.paymentFormId;if(t=StripeCheckout.configure({key:a.pbk,token:function(e,t){n.find('[name="enupalStripe[token]"]').val(e.id),n.find('[name="enupalStripe[email]"]').val(e.email),enupalStripe.addValuesToForm(n,t,a),n.find("#"+o).prop("disabled",!0).find("span").text(a.paymentButtonProcessingText),n.unbind("submit",[n,a]),n.submit()},opened:function(){},closed:function(){}}),a.coupon.enabled){var s=e("#check-coupon-button-"+a.paymentFormId);this.updateTotalAmoutLabel(n,a);var r=n.find("#remove-coupon-"+a.paymentFormId);this.updatesTotalLabelOnChoosesPlan(n,a),r.click(function(e){e.preventDefault(),i.handleRemoveCoupon(n,a,i)}),s.click(function(e){e.preventDefault(),i.handleCouponValidation(n,a,i)})}n.find("#"+o).on("click",function(e){var i=n[0];i.checkValidity()?(e.preventDefault(),enupalStripe.submitPayment(n,a,t)):i.reportValidity&&i.reportValidity()})},updateTotalAmoutLabel(e,n){var a=e.find("#total-amount-value-"+n.paymentFormId),t=this.getFinalAmount(e,n);a&&a.text(t)},updatesTotalLabelOnChoosesPlan(n,a){var t=this;if(0!==a.subscriptionType)if("radio"==a.subscriptionStyle){var i=n.find('input[name="enupalStripe[enupalMultiPlan]"]');e(i).change(function(){e(this).is(":checked")&&t.handleRemoveCoupon(n,a,t)})}else{var o=n.find('[name="enupalStripe[enupalMultiPlan]"]');e(o).on("change",function(){t.handleRemoveCoupon(n,a,t)})}},handleRemoveCoupon(e,n,a){var t=e.find("#coupon-message-"+n.paymentFormId),i=e.find("#remove-coupon-"+n.paymentFormId),o=e.find("#couponCode-"+n.paymentFormId);o&&o.val(""),t&&t.text(""),i.addClass("hidden"),e.find('[name="enupalCouponCode"]').val(""),a.updateTotalAmoutLabel(e,n)},handleCouponValidation(n,a,t){var i=n.find("#check-coupon-button-"+a.paymentFormId),o=n.find("#coupon-message-"+a.paymentFormId),s=n.find("#remove-coupon-"+a.paymentFormId),r=n.find("#total-amount-value-"+a.paymentFormId),u=n.find("#couponCode-"+a.paymentFormId),l=u.val(),p=a.stripe;u.val("");var d=this.convertToCents(t.getFinalAmount(n,a),p.currency);i.prop("disabled",!0);var c={action:"enupal-stripe/coupons/validate",amount:d,couponCode:l,isRecurring:this.getIsRecurring(n,a),currency:p.currency,successMessage:a.coupon.successMessage};e.ajax({type:"POST",url:"enupal/validate-coupon",data:c,dataType:"json",success:function(e){!0===e.success?(o.removeClass("coupon-error"),o.text(e.successMessage),s.removeClass("hidden"),r&&r.text(e.finalAmount),n.find('[name="enupalCouponCode"]').val(e.coupon.id)):(o.addClass("coupon-error"),s.addClass("hidden"),o.text(a.coupon.errorMessage)),i.prop("disabled",!1)}.bind(this),error:function(e,n,a){i.prop("disabled",!1),console.error(e,n,a.toString())}.bind(this)})},getIsRecurring:function(e,n){var a=!1;return 1==n.amountType&&(a=e.find('[name="enupalStripe[recurringToggle]"]').is(":checked")),n.enableSubscriptions&&(a=!0),a},addValuesToForm:function(e,n,a){if(a.stripe.shippingAddress){var t="shipping",i="address";this.setAddressToHiddenValues(t,i,n,e)}if(a.stripe.billingAddress){t="billing",i="billingAddress";this.setAddressToHiddenValues(t,i,n,e)}},setAddressToHiddenValues(e,n,a,t){a[e+"_name"]&&t.find('[name="enupalStripe['+n+'][name]"]').val(a[e+"_name"]),a[e+"_address_country"]&&t.find('[name="enupalStripe['+n+'][country]"]').val(a[e+"_address_country_code"]),a[e+"_address_zip"]&&t.find('[name="enupalStripe['+n+'][zip]"]').val(a[e+"_address_zip"]),a[e+"_address_state"]&&t.find('[name="enupalStripe['+n+'][state]"]').val(a[e+"_address_state"]),a[e+"_address_line1"]&&t.find('[name="enupalStripe['+n+'][line1]"]').val(a[e+"_address_line1"]),a[e+"_address_city"]&&t.find('[name="enupalStripe['+n+'][city]"]').val(a[e+"_address_city"])},submitPayment:function(n,a,t){var i=e.extend(!0,{},a),o=i.stripe;if(o.amount=this.convertToCents(this.getFinalAmount(n,i),o.currency),n.find('[name="enupalStripe[amount]"]').val(o.amount),n.find('[name="enupalStripe[testMode]"]').val(i.testMode),a.coupon.enabled){var s=n.find('[name="enupalCouponCode"]').val(),r=this.getIsRecurring(n,a);if(s){var u={amount:o.amount,couponCode:s,isRecurring:r,currency:o.currency,successMessage:a.coupon.successMessage};e.ajax({type:"POST",url:"enupal/validate-coupon",data:u,dataType:"json",success:function(e){!0===e.success&&(o.amount=e.finalAmountInCents),t.open(o)}.bind(this),error:function(e,n,a){console.error(e,n,a.toString())}.bind(this)})}else t.open(o)}else t.open(o)},getFinalAmount:function(n,a){var t=a.stripe.amount,i=0,o=!1;if(a.enableSubscriptions)if(0==a.subscriptionType){if(a.singleSetupFee>0&&(i=a.singleSetupFee),a.enableCustomPlanAmount)"undefined"!==(r=n.find('[name="enupalStripe[customPlanAmount]"]').val())&&r>0&&(t=r)}else{var s=null,r=null;if((s="radio"==a.subscriptionStyle?e('input[name="enupalStripe[enupalMultiPlan]"]:checked').val():n.find('[name="enupalStripe[enupalMultiPlan]"]').val())in a.multiplePlansAmounts&&(r=a.multiplePlansAmounts[s].amount,a.stripe.currency=a.multiplePlansAmounts[s].currency),s in a.setupFees){var u=a.setupFees[s];u>0&&(i=u)}"undefined"!==r&&r>0&&(t=r)}else if(1==a.amountType){var l=n.find('[name="enupalStripe[customAmount]"]').val();o=n.find('[name="enupalStripe[recurringToggle]"]').is(":checked"),"undefined"!==l&&l>0&&(t=l)}if((a.applyTax||o)&&a.enableTaxes){var p=parseFloat(a.tax/100*(parseFloat(t)+parseFloat(i))).toFixed(2);t=parseFloat(t)+parseFloat(p);var d=a.taxLabel+": "+a.currencySymbol+p;n.find('[name="enupalStripe[taxAmount]"]').val(p),n.find('[name="tax-amount-label"]').empty().append(d)}return parseFloat(t)+parseFloat(i)},convertToCents:function(e,n){return this.hasZeroDecimals(n)?e:(100*e).toFixed(0)},convertFromCents:function(e,n){return this.hasZeroDecimals(n)?e:e/100},hasZeroDecimals:function(e){for(var n=0;n<this.zeroDecimals.length;n++)if(this.zeroDecimals[n]===e.toUpperCase())return!0;return!1}},e(document).ready(function(e){enupalStripe.init()})}(jQuery);