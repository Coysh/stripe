/**
 * Stripe Payments plugin for Craft CMS 3.x
 *
 * @link      https://enupal.com/
 * @copyright Copyright (c) 2018 Enupal LLC
 */
var enupalStripe={};!function(e){"use strict";enupalStripe={paymentFormsList:{},finalData:{},zeroDecimals:{},init:function(){this.paymentFormsList=e(".enupal-stripe-form"),this.zeroDecimals=["MGA","BIF","CLP","PYG","DJF","RWF","GNF","UGX","JPY","VND","VUV","XAF","KMF","KRW","XOF","XPF"],this.paymentFormsList.each(function(){var n=e(this);enupalStripe.initializeForm(n)})},initializeForm:function(n){if(void 0===e(n).find('[name="enupalStripe[stripeData]"]').val())return!1;var i=e.parseJSON(e(n).find('[name="enupalStripe[stripeData]"]').val());e(n).find('[name="enupalStripe[stripeData]"]').val(""),this.finalData.finalAmount=i.stripe.amount;var a,t="stripe-payments-submit-button-"+i.paymentFormId;a=StripeCheckout.configure({key:i.pbk,token:function(e,a){n.find('[name="enupalStripe[token]"]').val(e.id),n.find('[name="enupalStripe[email]"]').val(e.email),enupalStripe.addValuesToForm(n,a,i),n.find("#"+t).prop("disabled",!0).find("span").text(i.paymentButtonProcessingText),n.unbind("submit",[n,i]),n.submit()},opened:function(){},closed:function(){}}),n.find("#"+t).on("click",function(e){var t=n[0];t.checkValidity()?(e.preventDefault(),enupalStripe.submitPayment(n,i,a)):t.reportValidity&&t.reportValidity()})},addValuesToForm:function(e,n,i){i.stripe.shippingAddress&&(n.shipping_name&&e.find('[name="enupalStripe[address][name]"]').val(n.shipping_name),n.shipping_address_country&&e.find('[name="enupalStripe[address][country]"]').val(n.shipping_address_country),n.shipping_address_zip&&e.find('[name="enupalStripe[address][zip]"]').val(n.shipping_address_zip),n.shipping_address_state&&e.find('[name="enupalStripe[address][state]"]').val(n.shipping_address_state),n.shipping_address_line1&&e.find('[name="enupalStripe[address][line1]"]').val(n.shipping_address_line1),n.shipping_address_city&&e.find('[name="enupalStripe[address][city]"]').val(n.shipping_address_city))},submitPayment:function(n,i,a){var t=e.extend(!0,{},i),s=t.stripe;s.amount=this.convertToCents(this.getFinalAmount(n,t),s.currency),n.find('[name="enupalStripe[amount]"]').val(s.amount),n.find('[name="enupalStripe[testMode]"]').val(t.testMode),a.open(s)},getFinalAmount:function(n,i){var a=i.stripe.amount,t=0,s=!1;if(i.enableSubscriptions)if(0==i.subscriptionType){if(i.singleSetupFee>0&&(t=i.singleSetupFee),i.enableCustomPlanAmount)"undefined"!==(p=n.find('[name="enupalStripe[customPlanAmount]"]').val())&&p>0&&(a=p)}else{var r=null,p=null;if((r="radio"==i.subscriptionStyle?e('input[name="enupalStripe[enupalMultiPlan]"]:checked').val():n.find('[name="enupalStripe[enupalMultiPlan]"]').val())in i.multiplePlansAmounts&&(p=i.multiplePlansAmounts[r].amount,i.stripe.currency=i.multiplePlansAmounts[r].currency),r in i.setupFees){var l=i.setupFees[r];l>0&&(t=l)}"undefined"!==p&&p>0&&(a=p)}else if(1==i.amountType){var u=n.find('[name="enupalStripe[customAmount]"]').val();s=n.find('[name="enupalStripe[recurringToggle]"]').is(":checked"),"undefined"!==u&&u>0&&(a=u)}if((i.applyTax||s)&&i.enableTaxes){var o=parseFloat(i.tax/100*(parseFloat(a)+parseFloat(t))).toFixed(2);a=parseFloat(a)+parseFloat(o);var d=i.taxLabel+": "+i.currencySymbol+o;n.find('[name="enupalStripe[taxAmount]"]').val(o),n.find('[name="tax-amount-label"]').empty().append(d)}return parseFloat(a)+parseFloat(t)},convertToCents:function(e,n){return this.hasZeroDecimals(n)?e:(100*e).toFixed(0)},convertFromCents:function(e,n){return this.hasZeroDecimals(n)?e:e/100},hasZeroDecimals:function(e){for(var n=0;n<this.zeroDecimals.length;n++)if(this.zeroDecimals[n]===e.toUpperCase())return!0;return!1}},e(document).ready(function(e){enupalStripe.init()})}(jQuery);