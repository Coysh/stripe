/**
 * Stripe Payments plugin for Craft CMS 3.x
 *
 * @link      https://enupal.com/
 * @copyright Copyright (c) 2018 Enupal LLC
 */
var enupalStripe={};!function(e){"use strict";enupalStripe={stripe:null,paymentFormsList:{},finalData:{},zeroDecimals:{},init:function(){this.paymentFormsList=e(".enupal-stripe-form-elements"),this.zeroDecimals=["MGA","BIF","CLP","PYG","DJF","RWF","GNF","UGX","JPY","VND","VUV","XAF","KMF","KRW","XOF","XPF"],this.paymentFormsList.each(function(){var n=e(this);enupalStripe.initializeForm(n)})},initializeForm:function(n){if(void 0===e(n).find('[name="enupalStripe[stripeData]"]').val())return!1;var t=e.parseJSON(e(n).find('[name="enupalStripe[stripeData]"]').val());e(n).find('[name="enupalStripe[stripeData]"]').val(""),this.finalData.finalAmount=t.stripe.amount;var a=Stripe(t.pbk),i=a.elements(),r=e(n).find('[name="paymentType"]'),s=t.paymentTypeIds;if(s.length>1){var l=n.find(".cc-wrapper"),o=n.find(".ideal-wrapper");e("#paymentMethod-"+t.paymentFormId).change(function(){var e=this.value;1==e?(r.val(e),l.removeClass("hidden"),o.addClass("hidden")):2==e&&(o.removeClass("hidden"),l.addClass("hidden"),r.val(e))})}for(var d=0,m=s.length;d<m;d++)1==s[d]?(0==d&&(n.find(".cc-wrapper").removeClass("hidden"),r.val(s[d])),this.createCardElement(a,t,i,n)):2==s[d]&&(0==d&&(n.find(".ideal-wrapper").removeClass("hidden"),r.val(s[d])),this.createIdealElement(a,t,n,i))},createCardElement:function(n,t,a,i){var r="stripe-payments-submit-button-"+t.paymentFormId,s=a.create("card",{hidePostalCode:!0,style:{base:{color:"#32325d",lineHeight:"18px",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}}});s.mount("#card-element-"+t.paymentFormId),s.addEventListener("change",function(e){var n=document.getElementById("card-errors-"+t.paymentFormId);e.error?n.textContent=e.error.message:n.textContent=""});i[0];var l=this;i.find("#"+r).on("click",function(a){if(1!=e(i).find('[name="paymentType"]').val())return!0;var o=i[0];if(o.checkValidity()){a.preventDefault();var d={};if(t.enableBillingAddress||t.enableShippingAddress)d={name:e(i).find('[name="address[name]"]').val(),address_line1:e(i).find('[name="address[line1]"]').val(),address_city:e(i).find('[name="address[city]"]').val(),address_state:e(i).find('[name="address[state]"]').val(),address_zip:e(i).find('[name="address[zip]"]').val(),address_country:e(i).find('[name="address[country]"]').val()};n.createToken(s,d).then(function(e){e.error?document.getElementById("card-errors-"+t.paymentFormId).textContent=e.error.message:l.submitForm(t,i,r,e.token)})}else o.reportValidity&&o.reportValidity()})},submitForm:function(n,t,a,i){var r=e.extend(!0,{},n),s=r.stripe;s.amount=this.convertToCents(this.getFinalAmount(t,r),s.currency),t.find('[name="enupalStripe[amount]"]').val(s.amount),t.find('[name="enupalStripe[testMode]"]').val(r.testMode),i&&t.find('[name="enupalStripe[token]"]').val(i.id),t.find("#"+a).prop("disabled",!0).find("span").text(n.paymentButtonProcessingText),t.unbind("submit",[t,n]),t.submit()},createIdealElement:function(n,t,a,i){var r=this,s=(document.getElementById("error-message-"+t.paymentFormId),a[0]),l="stripe-payments-submit-button-"+t.paymentFormId;s.addEventListener("submit",function(n){if(2!=e(a).find('[name="paymentType"]').val())return!0;n.preventDefault(),r.submitForm(t,a,l,null)})},getFinalAmount:function(n,t){var a=t.stripe.amount,i=0,r=!1;if(t.enableSubscriptions)if(0==t.subscriptionType){if(t.singleSetupFee>0&&(i=t.singleSetupFee),t.enableCustomPlanAmount)"undefined"!==(l=n.find('[name="enupalStripe[customPlanAmount]"]').val())&&l>0&&(a=l)}else{var s=null,l=null;if((s="radio"==t.subscriptionStyle?e('input[name="enupalStripe[enupalMultiPlan]"]:checked').val():n.find('[name="enupalStripe[enupalMultiPlan]"]').val())in t.multiplePlansAmounts&&(l=t.multiplePlansAmounts[s].amount,t.stripe.currency=t.multiplePlansAmounts[s].currency),s in t.setupFees){var o=t.setupFees[s];o>0&&(i=o)}"undefined"!==l&&l>0&&(a=l)}else if(1==t.amountType){var d=n.find('[name="enupalStripe[customAmount]"]').val();r=n.find('[name="enupalStripe[recurringToggle]"]').is(":checked"),"undefined"!==d&&d>0&&(a=d)}if((t.applyTax||r)&&t.enableTaxes){var m=parseFloat(t.tax/100*(parseFloat(a)+parseFloat(i))).toFixed(2);a=parseFloat(a)+parseFloat(m);var p=t.taxLabel+": "+t.currencySymbol+m;n.find('[name="enupalStripe[taxAmount]"]').val(m),n.find('[name="tax-amount-label"]').empty().append(p)}return parseFloat(a)+parseFloat(i)},convertToCents:function(e,n){return this.hasZeroDecimals(n)?e:(100*e).toFixed(0)},convertFromCents:function(e,n){return this.hasZeroDecimals(n)?e:e/100},hasZeroDecimals:function(e){for(var n=0;n<this.zeroDecimals.length;n++)if(this.zeroDecimals[n]===e.toUpperCase())return!0;return!1}},e(document).ready(function(e){enupalStripe.init()})}(jQuery);