/**
 * Stripe Payments plugin for Craft CMS 3.x
 *
 * @link      https://enupal.com/
 * @copyright Copyright (c) 2018 Enupal LLC
 */
var enupalStripe={};!function(e){"use strict";enupalStripe={stripe:null,paymentFormsList:{},finalData:{},zeroDecimals:{},globalStyle:{},init:function(n){this.globalStyle={base:{color:"#32325d",lineHeight:"18px",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},n&&(this.globalStyle=n),this.paymentFormsList=e(".enupal-stripe-form-elements"),this.zeroDecimals=["MGA","BIF","CLP","PYG","DJF","RWF","GNF","UGX","JPY","VND","VUV","XAF","KMF","KRW","XOF","XPF"],this.paymentFormsList.each(function(){var n=e(this);enupalStripe.initializeForm(n)})},initializeForm:function(n){if(void 0===e(n).find('[name="enupalStripe[stripeData]"]').val())return!1;var a=e.parseJSON(e(n).find('[name="enupalStripe[stripeData]"]').val()),t=this;navigator.userAgent.indexOf("Firefox")<0&&e(n).find('[name="enupalStripe[stripeData]"]').val(""),this.finalData.finalAmount=a.stripe.amount;var i=Stripe(a.pbk),r=i.elements({locale:a.stripe.locale}),o=e(n).find('[name="paymentType"]'),s=a.paymentTypeIds;if(s.length>1){var l=n.find(".cc-wrapper"),d=n.find(".ideal-wrapper"),u=n.find(".sofort-wrapper");e("#paymentMethod-"+a.paymentFormId).change(function(){var e=this.value;1==e?(o.val(e),l.removeClass("hidden"),d.addClass("hidden"),u.addClass("hidden")):2==e?(d.removeClass("hidden"),l.addClass("hidden"),u.addClass("hidden"),o.val(e)):3==e&&(u.removeClass("hidden"),d.addClass("hidden"),l.addClass("hidden"),o.val(e))})}if(a.enableShippingAddress&&a.enableBillingAddress){var p=n.find(".shippingAddressContainer");e("#sameAddressToggle-"+a.paymentFormId).change(function(){this.checked?p.addClass("hidden"):p.removeClass("hidden")})}if(a.coupon.enabled){var m=e("#check-coupon-button-"+a.paymentFormId);this.updateTotalAmoutLabel(n,a);var c=n.find("#remove-coupon-"+a.paymentFormId);this.updatesTotalLabelOnChoosesPlan(n,a),c.click(function(e){e.preventDefault(),t.handleRemoveCoupon(n,a,t)}),m.click(function(e){e.preventDefault(),t.handleCouponValidation(n,a,t)})}for(var f=0,v=s.length;f<v;f++)1==s[f]?(0==f&&(n.find(".cc-wrapper").removeClass("hidden"),o.val(s[f])),this.createCardElement(i,a,r,n)):2==s[f]?(0==f&&(n.find(".ideal-wrapper").removeClass("hidden"),o.val(s[f])),this.createIdealElement(i,a,n,r)):3==s[f]&&(0==f&&(n.find(".ideal-wrapper").removeClass("hidden"),n.find(".cc-wrapper").removeClass("hidden"),o.val(s[f])),this.createSofortElement(i,a,n,r))},updateTotalAmoutLabel(e,n){var a=e.find("#total-amount-value-"+n.paymentFormId),t=this.getFinalAmount(e,n);a&&a.text(t)},handleRemoveCoupon(e,n,a){var t=e.find("#coupon-message-"+n.paymentFormId),i=e.find("#remove-coupon-"+n.paymentFormId),r=e.find("#couponCode-"+n.paymentFormId);r&&r.val(""),t&&t.text(""),i.addClass("hidden"),e.find('[name="enupalCouponCode"]').val(""),a.updateTotalAmoutLabel(e,n)},handleCouponValidation(n,a,t){var i=n.find("#check-coupon-button-"+a.paymentFormId),r=n.find("#coupon-message-"+a.paymentFormId),o=n.find("#remove-coupon-"+a.paymentFormId),s=n.find("#total-amount-value-"+a.paymentFormId),l=n.find("#couponCode-"+a.paymentFormId),d=l.val(),u=a.stripe;l.val("");var p=this.convertToCents(t.getFinalAmount(n,a),u.currency);i.prop("disabled",!0);var m={action:"enupal-stripe/coupons/validate",amount:p,couponCode:d,isRecurring:this.getIsRecurring(n,a),currency:u.currency,successMessage:a.coupon.successMessage};e.ajax({type:"POST",url:"enupal/validate-coupon",data:m,dataType:"json",success:function(e){!0===e.success?(r.removeClass("coupon-error"),r.text(e.successMessage),o.removeClass("hidden"),s&&s.text(e.finalAmount),n.find('[name="enupalCouponCode"]').val(e.coupon.id)):(r.addClass("coupon-error"),o.addClass("hidden"),r.text(a.coupon.errorMessage)),i.prop("disabled",!1)}.bind(this),error:function(e,n,a){i.prop("disabled",!1),console.error(e,n,a.toString())}.bind(this)})},createCardElement:function(n,a,t,i){var r="stripe-payments-submit-button-"+a.paymentFormId,o=t.create("card",{hidePostalCode:!0,style:this.globalStyle});o.mount("#card-element-"+a.paymentFormId),o.addEventListener("change",function(e){var n=document.getElementById("card-errors-"+a.paymentFormId);e.error?n.textContent=e.error.message:n.textContent=""});i[0];var s=this;i.find("#"+r).on("click",function(t){if(1!=e(i).find('[name="paymentType"]').val())return!0;var l=i[0];a.enableBillingAddress&&a.enableBillingAddress&&("on"==e(i).find('[name="enupalStripe[sameAddressToggle]"]').val()&&(e(i).find('[name="address[name]"]').removeAttr("required"),e(i).find('[name="address[line1]"]').removeAttr("required"),e(i).find('[name="address[city]"]').removeAttr("required"),e(i).find('[name="address[state]"]').removeAttr("required"),e(i).find('[name="address[zip]"]').removeAttr("required"),e(i).find('[name="address[country]"]').removeAttr("required")));if(l.checkValidity()){t.preventDefault();var d={};a.enableBillingAddress&&(d={name:e(i).find('[name="billingAddress[name]"]').val(),address_line1:e(i).find('[name="billingAddress[line1]"]').val(),address_city:e(i).find('[name="billingAddress[city]"]').val(),address_state:e(i).find('[name="billingAddress[state]"]').val(),address_zip:e(i).find('[name="billingAddress[zip]"]').val(),address_country:e(i).find('[name="billingAddress[country]"]').val()}),n.createToken(o,d).then(function(e){e.error?document.getElementById("card-errors-"+a.paymentFormId).textContent=e.error.message:s.submitForm(a,i,r,e.token)})}else l.reportValidity&&l.reportValidity()})},submitForm:function(n,a,t,i){var r=e.extend(!0,{},n),o=r.stripe;o.amount=this.convertToCents(this.getFinalAmount(a,r),o.currency),a.find('[name="enupalStripe[amount]"]').val(o.amount),a.find('[name="enupalStripe[testMode]"]').val(r.testMode),i&&a.find('[name="enupalStripe[token]"]').val(i.id),a.find("#"+t).prop("disabled",!0).find("span").text(n.paymentButtonProcessingText),a.unbind("submit",[a,n]),a.submit()},createIdealElement:function(n,a,t,i){var r=this,o=t[0],s="stripe-payments-submit-button-"+a.paymentFormId,l=i.create("idealBank",{style:this.globalStyle});l.mount("#ideal-bank-element-"+a.paymentFormId),l.on("change",function(e){var n=e.value;t.find('[name="idealBank"]').val(n)}),o.addEventListener("submit",function(n){if(2!=e(t).find('[name="paymentType"]').val())return!0;n.preventDefault(),r.submitForm(a,t,s,null)})},createSofortElement:function(n,a,t,i){var r=this,o=t[0],s="stripe-payments-submit-button-"+a.paymentFormId;o.addEventListener("submit",function(n){if(3!=e(t).find('[name="paymentType"]').val())return!0;n.preventDefault(),r.submitForm(a,t,s,null)})},getIsRecurring:function(e,n){var a=!1;return 1==n.amountType&&(a=e.find('[name="enupalStripe[recurringToggle]"]').is(":checked")),n.enableSubscriptions&&(a=!0),a},getFinalAmount:function(e,n){var a=n.stripe.amount,t=0,i=!1;if(n.enableSubscriptions){var r=null;if(0==n.subscriptionType)n.singleSetupFee>0&&(t=n.singleSetupFee),n.enableCustomPlanAmount&&"undefined"!==(r=e.find('[name="enupalStripe[customPlanAmount]"]').val())&&r>0&&(a=r);else{var o=null;if(r=null,(o="radio"==n.subscriptionStyle?e.find('input[name="enupalStripe[enupalMultiPlan]"]:checked').val():e.find('[name="enupalStripe[enupalMultiPlan]"]').val())in n.multiplePlansAmounts&&(r=n.multiplePlansAmounts[o].amount,n.stripe.currency=n.multiplePlansAmounts[o].currency),o in n.setupFees){var s=n.setupFees[o];s>0&&(t=s)}"undefined"!==r&&r>0&&(a=r)}}else if(1==n.amountType){var l=e.find('[name="enupalStripe[customAmount]"]').val();i=e.find('[name="enupalStripe[recurringToggle]"]').is(":checked"),"undefined"!==l&&l>0&&(a=l)}if((n.applyTax||i)&&n.enableTaxes){var d=parseFloat(n.tax/100*(parseFloat(a)+parseFloat(t))).toFixed(2);a=parseFloat(a)+parseFloat(d);var u=n.taxLabel+": "+n.currencySymbol+d;e.find('[name="enupalStripe[taxAmount]"]').val(d),e.find('[name="tax-amount-label"]').empty().append(u)}return parseFloat(a)+parseFloat(t)},updatesTotalLabelOnChoosesPlan(n,a){var t=this;if(0!==a.subscriptionType)if("radio"==a.subscriptionStyle){var i=n.find('input[name="enupalStripe[enupalMultiPlan]"]');e(i).change(function(){e(this).is(":checked")&&t.handleRemoveCoupon(n,a,t)})}else{var r=n.find('[name="enupalStripe[enupalMultiPlan]"]');e(r).on("change",function(){t.handleRemoveCoupon(n,a,t)})}},convertToCents:function(e,n){return this.hasZeroDecimals(n)?e:(100*e).toFixed(0)},convertFromCents:function(e,n){return this.hasZeroDecimals(n)?e:e/100},hasZeroDecimals:function(e){for(var n=0;n<this.zeroDecimals.length;n++)if(this.zeroDecimals[n]===e.toUpperCase())return!0;return!1}},e(document).ready(function(e){var n=null;"undefined"!=typeof enupalStyleOverrides&&(n=enupalStyleOverrides),enupalStripe.init(n)})}(jQuery);